


<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>Extensions &#8212; slimta 4.0.8 documentation</title>
    <link rel="stylesheet" href="../_static/cloud.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Noticia+Text|Open+Sans|Droid+Sans+Mono" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/language_data.js"></script>
    <script type="text/javascript" src="../_static/jquery.cookie.js"></script>
    <script type="text/javascript" src="../_static/cloud.base.js"></script>
    <script type="text/javascript" src="../_static/cloud.js"></script>
    <link rel="shortcut icon" href="../_static/slimta.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Application Usage" href="slimta.html" />
    <link rel="prev" title="Mail Submission Agent" href="msa.html" /> 
        <meta name="viewport" content="width=device-width, initial-scale=1">
  </head><body>
    <div class="relbar-top">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="slimta.html" title="Application Usage"
             accesskey="N">next</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="msa.html" title="Mail Submission Agent"
             accesskey="P">previous</a> &nbsp; &nbsp;</li>
    <li><a href="../index.html">slimta 4.0.8 documentation</a> &#187;</li>

          <li class="nav-item nav-item-1"><a href="index.html" >Usage Manual</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="python-slimta.html" accesskey="U">Python Library Usage</a> &#187;</li> 
      </ul>
    </div>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="extensions">
<h1>Extensions<a class="headerlink" href="#extensions" title="Permalink to this headline">¶</a></h1>
<p>In an effort to keep a small number of dependencies and avoid a reputation for
“bloating”, several desirable features are included as extensions installed
separately. These extensions, and where and how to use them, are discussed
here.</p>
<div class="section" id="external-process-delivery">
<span id="pipe-relay-extension"></span><h2>External Process Delivery<a class="headerlink" href="#external-process-delivery" title="Permalink to this headline">¶</a></h2>
<div class="admonition caution">
<p class="admonition-title">Caution</p>
<p>This extension was deprecated in python-slimta version 0.3.21 in favor of
the <a class="reference internal" href="../api/slimta.relay.pipe.html#module-slimta.relay.pipe" title="slimta.relay.pipe"><code class="xref py py-mod docutils literal notranslate"><span class="pre">slimta.relay.pipe</span></code></a> module.</p>
</div>
<p>This simple extension uses the <a class="reference external" href="https://github.com/bombela/gevent_subprocess">gevent_subprocess</a> library to initiate local
delivery an external process. This simple mechanism is then used to support
delivery to applications such as <a class="reference external" href="http://www.courier-mta.org/maildrop/">courier-maildrop</a> and <a class="reference external" href="http://wiki.dovecot.org/LDA">dovecot-deliver</a>.</p>
<p>Installation of this extension is as simple as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ pip install python-slimta-piperelay
</pre></div>
</div>
<p>Take <a class="reference external" href="http://www.courier-mta.org/maildrop/">courier-maildrop</a> as an example. With a normal system configuration, the
following should be plenty to create a <code class="docutils literal notranslate"><span class="pre">slimta.piperelay.MaildropRelay</span></code>
instance:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">slimta.piperelay</span> <span class="k">import</span> <span class="n">MaildropRelay</span>

<span class="n">relay</span> <span class="o">=</span> <span class="n">MaildropRelay</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="cloud-storage">
<span id="id1"></span><h2>Cloud Storage<a class="headerlink" href="#cloud-storage" title="Permalink to this headline">¶</a></h2>
<p>This module makes available connectors to two cloud service providers,
<a class="reference external" href="https://www.rackspace.com/cloud/">Rackspace Cloud</a> and <a class="reference external" href="https://aws.amazon.com/">AWS</a>. <a class="reference internal" href="../api/slimta.envelope.html#slimta.envelope.Envelope" title="slimta.envelope.Envelope"><code class="xref py py-class docutils literal notranslate"><span class="pre">Envelope</span></code></a> data and queue metadata are written to
a cloud object store. Optionally, a reference to their location in the object
store is then written to a cloud message queue, which can alert relayers in
other processes of the availability of a new message in the object store.</p>
<p>Install this extension with the following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ pip install python-slimta-cloudstorage
</pre></div>
</div>
<p>To use the <a class="reference external" href="https://www.rackspace.com/cloud/">Rackspace Cloud</a> services available in the extension, you need
instances of the <a class="reference internal" href="../api/extra.cloudstorage.rackspace.html#slimta.cloudstorage.rackspace.RackspaceCloudAuth" title="slimta.cloudstorage.rackspace.RackspaceCloudAuth"><code class="xref py py-class docutils literal notranslate"><span class="pre">RackspaceCloudAuth</span></code></a>,
<a class="reference internal" href="../api/extra.cloudstorage.rackspace.html#slimta.cloudstorage.rackspace.RackspaceCloudFiles" title="slimta.cloudstorage.rackspace.RackspaceCloudFiles"><code class="xref py py-class docutils literal notranslate"><span class="pre">RackspaceCloudFiles</span></code></a>, and optionally
<a class="reference internal" href="../api/extra.cloudstorage.rackspace.html#slimta.cloudstorage.rackspace.RackspaceCloudQueues" title="slimta.cloudstorage.rackspace.RackspaceCloudQueues"><code class="xref py py-class docutils literal notranslate"><span class="pre">RackspaceCloudQueues</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">auth</span> <span class="o">=</span> <span class="n">RackspaceCloudAuth</span><span class="p">({</span><span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="s1">&#39;slimta&#39;</span><span class="p">,</span> <span class="s1">&#39;api_key&#39;</span><span class="p">:</span> <span class="s1">&#39;XXXXXXXXXXXX&#39;</span><span class="p">},</span>
                          <span class="n">region</span><span class="o">=</span><span class="s1">&#39;IAD&#39;</span><span class="p">)</span>
<span class="n">cloud_files</span> <span class="o">=</span> <span class="n">RackspaceCloudFiles</span><span class="p">(</span><span class="n">auth</span><span class="p">)</span>
<span class="n">cloud_queues</span> <span class="o">=</span> <span class="n">RackspaceCloudQueues</span><span class="p">(</span><span class="n">auth</span><span class="p">)</span>
</pre></div>
</div>
<p>Using <a class="reference external" href="https://aws.amazon.com/">AWS</a> services is a bit different. First, it requires installation and
configuration of the <a class="reference external" href="https://boto.readthedocs.io/en/latest/ref/boto.html#module-boto" title="(in boto v2.49.0)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">boto</span></code></a> library:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ pip install boto
</pre></div>
</div>
<p>Using the <a class="reference external" href="https://boto.readthedocs.io/en/latest/ref/boto.html#module-boto" title="(in boto v2.49.0)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">boto</span></code></a> library, we need to come up with references to a
<a class="reference external" href="https://boto.readthedocs.io/en/latest/ref/s3.html#boto.s3.bucket.Bucket" title="(in boto v2.49.0)"><code class="xref py py-class docutils literal notranslate"><span class="pre">Bucket</span></code></a> and optionally a
<a class="reference external" href="https://boto.readthedocs.io/en/latest/ref/sqs.html#boto.sqs.queue.Queue" title="(in boto v2.49.0)"><code class="xref py py-class docutils literal notranslate"><span class="pre">Queue</span></code></a>. Then, use them to create
<a class="reference internal" href="../api/extra.cloudstorage.aws.html#slimta.cloudstorage.aws.SimpleStorageService" title="slimta.cloudstorage.aws.SimpleStorageService"><code class="xref py py-class docutils literal notranslate"><span class="pre">SimpleStorageService</span></code></a> and
<a class="reference internal" href="../api/extra.cloudstorage.aws.html#slimta.cloudstorage.aws.SimpleQueueService" title="slimta.cloudstorage.aws.SimpleQueueService"><code class="xref py py-class docutils literal notranslate"><span class="pre">SimpleQueueService</span></code></a> objects:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">boto.s3.connection</span> <span class="k">import</span> <span class="n">S3Connection</span>
<span class="n">s3_conn</span> <span class="o">=</span> <span class="n">S3Connection</span><span class="p">(</span><span class="s1">&#39;1A2B3C4D5E&#39;</span><span class="p">,</span> <span class="s1">&#39;XXXXXXXXXXXX&#39;</span><span class="p">)</span>
<span class="n">s3_bucket</span> <span class="o">=</span> <span class="n">s3_conn</span><span class="o">.</span><span class="n">get_bucket</span><span class="p">(</span><span class="s1">&#39;slimta-queue&#39;</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">boto.sqs</span>
<span class="n">sqs_conn</span> <span class="o">=</span> <span class="n">boto</span><span class="o">.</span><span class="n">sqs</span><span class="o">.</span><span class="n">connect_to_region</span><span class="p">(</span><span class="s1">&#39;us-west-2&#39;</span><span class="p">,</span>
        <span class="n">aws_access_key_id</span><span class="o">=</span><span class="s1">&#39;1A2B3C4D5E&#39;</span><span class="p">,</span>
        <span class="n">aws_secret_access_key</span><span class="o">=</span><span class="s1">&#39;XXXXXXXXXXXX&#39;</span><span class="p">)</span>
<span class="n">sqs_queue</span> <span class="o">=</span> <span class="n">sqs_conn</span><span class="o">.</span><span class="n">create_queue</span><span class="p">(</span><span class="s1">&#39;slimta-queue&#39;</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">slimta.cloudstorage.aws</span> <span class="k">import</span> <span class="n">SimpleStorageService</span><span class="p">,</span> <span class="n">SimpleQueueService</span>
<span class="n">s3</span> <span class="o">=</span> <span class="n">SimpleStorageService</span><span class="p">(</span><span class="n">s3_bucket</span><span class="p">)</span>
<span class="n">sqs</span> <span class="o">=</span> <span class="n">SimpleQueueService</span><span class="p">(</span><span class="n">sqs_queue</span><span class="p">)</span>
</pre></div>
</div>
<p>Once you have these objects created for your cloud service, link them together
into a queue storage driver using <a class="reference internal" href="../api/extra.cloudstorage.html#slimta.cloudstorage.CloudStorage" title="slimta.cloudstorage.CloudStorage"><code class="xref py py-class docutils literal notranslate"><span class="pre">CloudStorage</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">slimta.cloudstorage</span> <span class="k">import</span> <span class="n">CloudStorage</span>

<span class="n">storage</span> <span class="o">=</span> <span class="n">CloudStorage</span><span class="p">(</span><span class="n">cloud_files</span><span class="p">,</span> <span class="n">cloud_queues</span><span class="p">)</span>
<span class="c1"># or...</span>
<span class="n">storage</span> <span class="o">=</span> <span class="n">CloudStorage</span><span class="p">(</span><span class="n">s3</span><span class="p">,</span> <span class="n">sqs</span><span class="p">)</span>
</pre></div>
</div>
<p>This object can then be used anywhere a <a class="reference internal" href="../api/slimta.queue.html#slimta.queue.QueueStorage" title="slimta.queue.QueueStorage"><code class="xref py py-class docutils literal notranslate"><span class="pre">QueueStorage</span></code></a>
object is required.</p>
</div>
<div class="section" id="disk-storage">
<span id="id2"></span><h2>Disk Storage<a class="headerlink" href="#disk-storage" title="Permalink to this headline">¶</a></h2>
<p>In the fashion of traditional MTAs, the <a class="reference internal" href="../api/extra.diskstorage.html#module-slimta.diskstorage" title="slimta.diskstorage"><code class="xref py py-mod docutils literal notranslate"><span class="pre">diskstorage</span></code></a> extension
writes <a class="reference internal" href="../api/slimta.envelope.html#slimta.envelope.Envelope" title="slimta.envelope.Envelope"><code class="xref py py-class docutils literal notranslate"><span class="pre">Envelope</span></code></a> data and queue metadata directly to disk to configurable
directories. This extension relies on <a class="reference external" href="https://github.com/felipecruz/pyaio">pyaio</a> to asynchronously write and read
files on disk.</p>
<p>To ensure file creation and modification is atomic, files are
first written to a scratch directory and then <a class="reference external" href="https://docs.python.org/3/library/os.html#os.rename" title="(in Python v3.7)"><code class="xref py py-func docutils literal notranslate"><span class="pre">os.rename()</span></code></a> moves them to
their final destination. For this reason, it is important that the scratch
directory (<code class="docutils literal notranslate"><span class="pre">tmp_dir</span></code> argument in the constructor) reside on the same
filesystem as the envelope and meta directories (<code class="docutils literal notranslate"><span class="pre">env_dir</span></code> and <code class="docutils literal notranslate"><span class="pre">meta_dir</span></code>
arguments, respectively).</p>
<p>The files created in the envelope directory will be identified by a
<a class="reference external" href="https://docs.python.org/3/library/uuid.html#uuid.uuid4" title="(in Python v3.7)"><code class="xref py py-func docutils literal notranslate"><span class="pre">uuid4()</span></code></a> <a class="reference external" href="https://docs.python.org/3/library/uuid.html#uuid.UUID.hex" title="(in Python v3.7)"><code class="xref py py-attr docutils literal notranslate"><span class="pre">hexadecimal</span> <span class="pre">string</span></code></a> appended with
the suffix <code class="docutils literal notranslate"><span class="pre">.env</span></code>. The files created in the meta directory will be identified
by the same uuid string as its corresponding envelope file, but with the suffix
<code class="docutils literal notranslate"><span class="pre">.meta</span></code>. The envelope and meta directories can be the same, but two
<a class="reference internal" href="../api/extra.diskstorage.html#slimta.diskstorage.DiskStorage" title="slimta.diskstorage.DiskStorage"><code class="xref py py-class docutils literal notranslate"><span class="pre">DiskStorage</span></code></a> should not share directories.</p>
<p>To install this extension:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ pip install python-slimta-diskstorage
</pre></div>
</div>
<p>And to initialize a new <a class="reference internal" href="../api/extra.diskstorage.html#slimta.diskstorage.DiskStorage" title="slimta.diskstorage.DiskStorage"><code class="xref py py-class docutils literal notranslate"><span class="pre">DiskStorage</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">slimta.diskstorage</span> <span class="k">import</span> <span class="n">DiskStorage</span>

<span class="n">queue_dir</span> <span class="o">=</span> <span class="s1">&#39;/var/spool/slimta/queue&#39;</span>
<span class="n">queue</span> <span class="o">=</span> <span class="n">DiskStorage</span><span class="p">(</span><span class="n">queue_dir</span><span class="p">,</span> <span class="n">queue_dir</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="redis-storage">
<span id="id3"></span><h2>Redis Storage<a class="headerlink" href="#redis-storage" title="Permalink to this headline">¶</a></h2>
<p>Taking advantage of the advanced data structures and ease of use of the <a class="reference external" href="http://redis.io/">redis</a>
database, the <a class="reference internal" href="../api/extra.redisstorage.html#module-slimta.redisstorage" title="slimta.redisstorage"><code class="xref py py-mod docutils literal notranslate"><span class="pre">redisstorage</span></code></a> extension simply creates a hash key
for each queued message, containing its delivery metadata and a pickled version
of the <a class="reference internal" href="../api/slimta.envelope.html#slimta.envelope.Envelope" title="slimta.envelope.Envelope"><code class="xref py py-class docutils literal notranslate"><span class="pre">Envelope</span></code></a>.</p>
<p>The keys created in redis will look like the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">redis</span> <span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">6379</span><span class="o">&gt;</span> <span class="n">KEYS</span> <span class="o">*</span>
<span class="mi">1</span><span class="p">)</span> <span class="s2">&quot;slimta:28195d3b0a5847f9853e5b0173c85151&quot;</span>
<span class="mi">2</span><span class="p">)</span> <span class="s2">&quot;slimta:5ebb94976cd94b418d6063a2ca4cbf8f&quot;</span>
<span class="mi">3</span><span class="p">)</span> <span class="s2">&quot;slimta:d33879cf66244472b983770ba762e07b&quot;</span>
<span class="n">redis</span> <span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">6379</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>Each key is a hash that will look something like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">redis</span> <span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">6379</span><span class="o">&gt;</span> <span class="n">HGETALL</span> <span class="n">slimta</span><span class="p">:</span><span class="n">d33879cf66244472b983770ba762e07b</span>
<span class="mi">1</span><span class="p">)</span> <span class="s2">&quot;attempts&quot;</span>
<span class="mi">2</span><span class="p">)</span> <span class="s2">&quot;2&quot;</span>
<span class="mi">3</span><span class="p">)</span> <span class="s2">&quot;timestamp&quot;</span>
<span class="mi">4</span><span class="p">)</span> <span class="s2">&quot;1377121655&quot;</span>
<span class="mi">5</span><span class="p">)</span> <span class="s2">&quot;envelope&quot;</span>
<span class="mi">6</span><span class="p">)</span> <span class="s2">&quot;...&quot;</span>
<span class="n">redis</span> <span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">6379</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>On startup, the <a class="reference internal" href="../api/slimta.queue.html#slimta.queue.Queue" title="slimta.queue.Queue"><code class="xref py py-class docutils literal notranslate"><span class="pre">Queue</span></code></a> will scan the keyspace (using the customizable prefix
<code class="docutils literal notranslate"><span class="pre">slimta:</span></code>) and populate the queue with existing messages for delivery.</p>
<p>To install this extension:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ pip install python-slimta-redisstorage
</pre></div>
</div>
<p>And to initialize a new <a class="reference internal" href="../api/extra.redisstorage.html#slimta.redisstorage.RedisStorage" title="slimta.redisstorage.RedisStorage"><code class="xref py py-class docutils literal notranslate"><span class="pre">RedisStorage</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">slimta.redisstorage</span> <span class="k">import</span> <span class="n">RedisStorage</span>

<span class="n">store</span> <span class="o">=</span> <span class="n">RedisStorage</span><span class="p">(</span><span class="s1">&#39;redis.example.com&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="celery-distributed-queuing">
<span id="celery-queue"></span><h2>Celery Distributed Queuing<a class="headerlink" href="#celery-distributed-queuing" title="Permalink to this headline">¶</a></h2>
<div class="section" id="why-it-s-better">
<h3>Why It’s Better<a class="headerlink" href="#why-it-s-better" title="Permalink to this headline">¶</a></h3>
<p>One of the original inspirations for <a class="reference external" href="https://slimta.org/">slimta</a> was splitting apart the “big 3”
components of an MTA in such a way that different server clusters could be
responsible for each component. These “big 3” components are called the <em>edge</em>,
the <em>queue</em>, and the <em>relay</em> in this library.</p>
<p>One of the largest and most complicated pieces of logic in modern-day <a class="reference external" href="https://en.wikipedia.org/wiki/E-mail_service_provider">ESPs</a>
is anti-abuse. It is reasonable to assume that simply handling inbound traffic
from a <a class="reference external" href="https://www.maawg.org/email_metrics_report">spam-filled world</a> is more than enough for a server cluster to be
responsible for. The server running the <em>edge</em> service should be able to simply
hand off a received message for delivery to the <em>queue</em> running on another
machine.</p>
<p>Despite the name, a <em>queue</em> in the MTA sense is not a simple FIFO we learned
about in our Computer Science course. It is responsible at a minimum for:</p>
<ul class="simple">
<li><p>Receiving new messages from the <em>edge</em> and persistently storing them.</p></li>
<li><p>Requesting delivery from the <em>relay</em> service.</p></li>
<li><p>Delaying message delivery retry after transient failures.</p></li>
<li><p>Reporting permanent delivery failure back to the sender with a bounce
message.</p></li>
</ul>
<p>If you’re familiar with the <a class="reference external" href="http://www.celeryproject.org/">Celery Distributed Task Queue</a>, it fits the bill
perfectly.</p>
</div>
<div class="section" id="setting-it-up">
<h3>Setting It Up<a class="headerlink" href="#setting-it-up" title="Permalink to this headline">¶</a></h3>
<p>Celery will actually take care of managing the <em>relay</em> and <em>queue</em> services,
when all is said and done. The message broker and results backend of Celery
act as the <em>queue</em>, and the task workers act as the <em>relay</em>.</p>
<p>In a new file (I called mine <code class="docutils literal notranslate"><span class="pre">mytasks.py</span></code>), set up your <code class="docutils literal notranslate"><span class="pre">celery</span></code> object:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">celery</span> <span class="k">import</span> <span class="n">Celery</span>

<span class="n">celery</span> <span class="o">=</span> <span class="n">Celery</span><span class="p">(</span><span class="s1">&#39;mytasks&#39;</span><span class="p">,</span> <span class="n">broker</span><span class="o">=</span><span class="s1">&#39;redis://localhost/0&#39;</span><span class="p">,</span>
                           <span class="n">backend</span><span class="o">=</span><span class="s1">&#39;redis://localhost/0&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>We’ll also set up our <a class="reference internal" href="../api/slimta.relay.html#slimta.relay.Relay" title="slimta.relay.Relay"><code class="xref py py-class docutils literal notranslate"><span class="pre">Relay</span></code></a> object now:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">slimta.relay.smtp.mx</span> <span class="k">import</span> <span class="n">MxSmtpRelay</span>

<span class="n">relay</span> <span class="o">=</span> <span class="n">MxSmtpRelay</span><span class="p">()</span>
</pre></div>
</div>
<p>Next, create a new <a class="reference internal" href="../api/extra.celeryqueue.html#slimta.celeryqueue.CeleryQueue" title="slimta.celeryqueue.CeleryQueue"><code class="xref py py-class docutils literal notranslate"><span class="pre">CeleryQueue</span></code></a> using both of these
objects:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">slimta.celeryqueue</span> <span class="k">import</span> <span class="n">CeleryQueue</span>

<span class="n">queue</span> <span class="o">=</span> <span class="n">CeleryQueue</span><span class="p">(</span><span class="n">celery</span><span class="p">,</span> <span class="n">relay</span><span class="p">)</span>
</pre></div>
</div>
<p>Simply creating a <a class="reference internal" href="../api/extra.celeryqueue.html#slimta.celeryqueue.CeleryQueue" title="slimta.celeryqueue.CeleryQueue"><code class="xref py py-class docutils literal notranslate"><span class="pre">CeleryQueue</span></code></a> instance will
register a new celery task called <code class="docutils literal notranslate"><span class="pre">attempt_delivery</span></code>. Each delivery attempt
and retry will call this task, including delivery of bounce messages.</p>
<p>Now, back inside your <a class="reference external" href="https://slimta.org/">slimta</a> application code, you can import <code class="docutils literal notranslate"><span class="pre">queue</span></code>
from this file, add your policies, and create your <a class="reference internal" href="../api/slimta.edge.html#slimta.edge.Edge" title="slimta.edge.Edge"><code class="xref py py-class docutils literal notranslate"><span class="pre">Edge</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mytasks</span> <span class="k">import</span> <span class="n">queue</span>
<span class="kn">from</span> <span class="nn">slimta.policy.headers</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">slimta.edge.smtp</span> <span class="k">import</span> <span class="n">SmtpEdge</span>

<span class="n">queue</span><span class="o">.</span><span class="n">add_policy</span><span class="p">(</span><span class="n">AddDateHeader</span><span class="p">())</span>
<span class="n">queue</span><span class="o">.</span><span class="n">add_policy</span><span class="p">(</span><span class="n">AddMessageIdHeader</span><span class="p">())</span>
<span class="n">queue</span><span class="o">.</span><span class="n">add_policy</span><span class="p">(</span><span class="n">AddReceivedHeader</span><span class="p">())</span>

<span class="n">edge</span> <span class="o">=</span> <span class="n">SmtpEdge</span><span class="p">((</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span> <span class="n">queue</span><span class="p">)</span>
<span class="n">edge</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</pre></div>
</div>
<p>Finally, in a new terminal start your task worker, using <a class="reference external" href="http://www.gevent.org/api/gevent.html#module-gevent" title="(in gevent v1.5a2.dev0)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">gevent</span></code></a> as the
worker thread pool:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ celery worker -A mytasks -l debug -P gevent
</pre></div>
</div>
<p>Now you are all set up with a distributed Celery queue! You’re now free to
scale your <em>edge</em> by adding more machines running <a class="reference internal" href="../api/slimta.edge.smtp.html#slimta.edge.smtp.SmtpEdge" title="slimta.edge.smtp.SmtpEdge"><code class="xref py py-class docutils literal notranslate"><span class="pre">SmtpEdge</span></code></a> to the a <code class="docutils literal notranslate"><span class="pre">queue</span></code>
with the same backend and broker. You’re now free to scale your <em>queue</em> by
scaling your backend and broker (might be easier with RabbitMQ than Redis).
And finally, you’re free to scale your <em>relay</em> by adding machines designated as
Celery task workers. Go nuts!</p>
</div>
</div>
<div class="section" id="sender-policy-framework-spf">
<span id="enforce-spf"></span><h2>Sender Policy Framework (SPF)<a class="headerlink" href="#sender-policy-framework-spf" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://en.wikipedia.org/wiki/Sender_Policy_Framework">SPF</a> is a tool that, at its most basic, allows domains to explicitly list the
outbound hosts/IPs from which they are legitimately sending mail. Domains may
set DNS records of special formats that email receivers query and compare
against the information they know about the sending client.</p>
<p>To set it up, you need to create rules for the different types of results. You
do this by creating a <a class="reference internal" href="../api/extra.spf.html#slimta.spf.EnforceSpf" title="slimta.spf.EnforceSpf"><code class="xref py py-class docutils literal notranslate"><span class="pre">EnforceSpf</span></code></a> object and calling
<a class="reference internal" href="../api/extra.spf.html#slimta.spf.EnforceSpf.set_enforcement" title="slimta.spf.EnforceSpf.set_enforcement"><code class="xref py py-meth docutils literal notranslate"><span class="pre">set_enforcement()</span></code></a> for each different results you
want to act upon. These results are:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://tools.ietf.org/html/rfc4408#section-2.5.1">none</a></p></li>
<li><p><a class="reference external" href="https://tools.ietf.org/html/rfc4408#section-2.5.2">neutral</a></p></li>
<li><p><a class="reference external" href="https://tools.ietf.org/html/rfc4408#section-2.5.3">pass</a></p></li>
<li><p><a class="reference external" href="https://tools.ietf.org/html/rfc4408#section-2.5.4">fail</a></p></li>
<li><p><a class="reference external" href="https://tools.ietf.org/html/rfc4408#section-2.5.5">softfail</a></p></li>
<li><p><a class="reference external" href="https://tools.ietf.org/html/rfc4408#section-2.5.6">temperror</a></p></li>
<li><p><a class="reference external" href="https://tools.ietf.org/html/rfc4408#section-2.5.7">permerror</a></p></li>
</ul>
<p>So we create our rules:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">spf</span> <span class="o">=</span> <span class="n">EnforceSpf</span><span class="p">()</span>
<span class="n">spf</span><span class="o">.</span><span class="n">set_enforcement</span><span class="p">(</span><span class="s1">&#39;fail&#39;</span><span class="p">,</span> <span class="n">match_message</span><span class="o">=</span><span class="s1">&#39;5.7.1 Access denied: </span><span class="si">{reason}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">spf</span><span class="o">.</span><span class="n">set_enforcement</span><span class="p">(</span><span class="s1">&#39;softfail&#39;</span><span class="p">,</span> <span class="n">match_code</span><span class="o">=</span><span class="s1">&#39;250&#39;</span><span class="p">,</span> <span class="n">match_message</span><span class="o">=</span><span class="s1">&#39;2.0.0 Ok; </span><span class="si">{reason}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>And then in our <a class="reference internal" href="../api/slimta.edge.smtp.html#slimta.edge.smtp.SmtpValidators" title="slimta.edge.smtp.SmtpValidators"><code class="xref py py-class docutils literal notranslate"><span class="pre">SmtpValidators</span></code></a> class, use the
<a class="reference internal" href="../api/extra.spf.html#slimta.spf.EnforceSpf.check" title="slimta.spf.EnforceSpf.check"><code class="xref py py-meth docutils literal notranslate"><span class="pre">check()</span></code></a> decorator:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@spf</span><span class="o">.</span><span class="n">check</span>
<span class="k">def</span> <span class="nf">validate_mail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reply</span><span class="p">,</span> <span class="n">sender</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
        <p class="logo"><a href="../index.html" title="index">
          <img class="logo" src="../_static/slimta.svg" alt="Logo"/>
        </a></p><div class="sphinx-toc sphinxlocaltoc">
    <h3><a href="../index.html">Page contents</a></h3>
    <ul>
<li><a class="reference internal" href="#">Extensions</a><ul>
<li><a class="reference internal" href="#external-process-delivery">External Process Delivery</a></li>
<li><a class="reference internal" href="#cloud-storage">Cloud Storage</a></li>
<li><a class="reference internal" href="#disk-storage">Disk Storage</a></li>
<li><a class="reference internal" href="#redis-storage">Redis Storage</a></li>
<li><a class="reference internal" href="#celery-distributed-queuing">Celery Distributed Queuing</a><ul>
<li><a class="reference internal" href="#why-it-s-better">Why It’s Better</a></li>
<li><a class="reference internal" href="#setting-it-up">Setting It Up</a></li>
</ul>
</li>
<li><a class="reference internal" href="#sender-policy-framework-spf">Sender Policy Framework (SPF)</a></li>
</ul>
</li>
</ul>

  </div>
  <div class="sphinxprev">
    <h4>Previous page</h4>
    <p class="topless"><a href="msa.html"
                          title="Previous page">&larr; Mail Submission Agent</a></p>
  </div>
  <div class="sphinxnext">
    <h4>Next page</h4>
    <p class="topless"><a href="slimta.html"
                          title="Next page">&rarr; Application Usage</a></p>
  </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
    
    
        <div class="sidebar-toggle-group no-js">
            
            <button class="sidebar-toggle" id="sidebar-hide" title="Hide the sidebar menu">
                 «
                <span class="show-for-small">hide menu</span>
                
            </button>
            <button class="sidebar-toggle" id="sidebar-show" title="Show the sidebar menu">
                
                <span class="show-for-small">menu</span>
                <span class="hide-for-small">sidebar</span>
                 »
            </button>
        </div>
    
      <div class="clearer"></div>
    </div>
    <div class="relbar-bottom">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="slimta.html" title="Application Usage"
             >next</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="msa.html" title="Mail Submission Agent"
             >previous</a> &nbsp; &nbsp;</li>
    <li><a href="../index.html">slimta 4.0.8 documentation</a> &#187;</li>

          <li class="nav-item nav-item-1"><a href="index.html" >Usage Manual</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="python-slimta.html" >Python Library Usage</a> &#187;</li> 
      </ul>
    </div>
    </div>


    <div class="footer" role="contentinfo">
        &#169; Copyright 2019, Ian Good.
    </div>
    <!-- cloud_sptheme 1.4 -->
<script type="text/javascript">
  document._EUGO = 'ff80897801813c8394e7';
  document.head.appendChild(function() {
    var s = document.createElement('script');
    s.src = 'https://eugo.io/eugo.js';
    s.async = 1;
    return s;
  }());
</script>

  </body>
</html>