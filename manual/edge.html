


<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Edge Services &#8212; slimta 4.0.8 documentation</title>
    <link rel="stylesheet" href="../_static/cloud.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Noticia+Text|Open+Sans|Droid+Sans+Mono" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/language_data.js"></script>
    <script type="text/javascript" src="../_static/jquery.cookie.js"></script>
    <script type="text/javascript" src="../_static/cloud.base.js"></script>
    <script type="text/javascript" src="../_static/cloud.js"></script>
    <link rel="shortcut icon" href="../_static/slimta.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Queue Services" href="queue.html" />
    <link rel="prev" title="Envelope Objects" href="envelopes.html" /> 
        <meta name="viewport" content="width=device-width, initial-scale=1">
  </head><body>
    <div class="relbar-top">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="queue.html" title="Queue Services"
             accesskey="N">next</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="envelopes.html" title="Envelope Objects"
             accesskey="P">previous</a> &nbsp; &nbsp;</li>
    <li><a href="../index.html">slimta 4.0.8 documentation</a> &#187;</li>

          <li class="nav-item nav-item-1"><a href="index.html" >Usage Manual</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="python-slimta.html" accesskey="U">Python Library Usage</a> &#187;</li> 
      </ul>
    </div>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="edge-services">
<h1>Edge Services<a class="headerlink" href="#edge-services" title="Permalink to this headline">¶</a></h1>
<p>The term <em>edge</em> is not necessarily common among other <em>MTAs</em>. It was adapted
loosely by <a class="reference external" href="https://slimta.org/">slimta</a> from the <a class="reference external" href="https://technet.microsoft.com/en-us/library/bb124701.aspx">Edge Transport Server Role</a> in Microsoft
Exchange, but the name is about where the similarities end.</p>
<p>In <a class="reference external" href="https://slimta.org/">slimta</a>, an edge service are those that are listening for new messages
entering the system. The protocol does not matter, an edge service produces an
<a class="reference internal" href="../api/slimta.envelope.html#slimta.envelope.Envelope" title="slimta.envelope.Envelope"><code class="xref py py-class docutils literal notranslate"><span class="pre">Envelope</span></code></a> object and hands it off to the next stage of delivery.</p>
<p>Edge services (usually) send their requests to and receive their responses from
a <em>queue</em> service. That means the response delivered to the client does not
signify whether the message was successfully delivered, but rather that the
<em>queue</em> service has taken responsibility for its delivery.</p>
<div class="section" id="smtp-edge-services">
<span id="edge-smtp"></span><h2>SMTP Edge Services<a class="headerlink" href="#smtp-edge-services" title="Permalink to this headline">¶</a></h2>
<p>Traditionally, email <em>MTAs</em> receive messages from other <em>MTAs</em> or user email
clients using the SMTP protocol (<a class="reference external" href="https://tools.ietf.org/html/rfc5321">RFC 5321</a>, <a class="reference external" href="https://tools.ietf.org/html/rfc2821">RFC 2821</a>, <a class="reference external" href="https://tools.ietf.org/html/rfc821">RFC 821</a>). An SMTP
session delivering a message from a client to a server might look like this,
with server (edge) replies back to the client bolded:</p>
<pre class="literal-block">
<strong>220 slimta.org ESMTP Mail Gateway</strong>
EHLO client.example.com
<strong>250-Hello client.example.com</strong>
<strong>250-8BITMIME</strong>
<strong>250-PIPELINING</strong>
<strong>250-STARTTLS</strong>
<strong>250 ENHANCEDSTATUSCODES</strong>
MAIL FROM:&lt;<a class="reference external" href="mailto:sender&#37;&#52;&#48;client&#46;example&#46;com">sender<span>&#64;</span>client<span>&#46;</span>example<span>&#46;</span>com</a>&gt;
<strong>250 2.1.0 &lt;sender&#64;client.example.com&gt; Ok</strong>
RCPT TO:&lt;<a class="reference external" href="mailto:recipient&#37;&#52;&#48;server&#46;example&#46;com">recipient<span>&#64;</span>server<span>&#46;</span>example<span>&#46;</span>com</a>&gt;
<strong>250 2.1.5 &lt;recipient&#64;server.example.com&gt; Ok</strong>
DATA
<strong>354 Start mail input; end with &lt;CRLF&gt;.&lt;CRLF&gt;</strong>
... email data ...
.
<strong>250 2.6.0 Message queued as e64820855322425486542d1bd59ba6cd</strong>
QUIT
<strong>221 2.0.0 Bye</strong>
</pre>
<p>SMTP edge services are somewhat unique in that they control not just the receipt
of and response to the message, but also a lot of interim requests. A server may
respond negatively to any command sent to it by the client, and often, crucial
policies are implemented that way. For example, if you are sure you don’t want
to accept messages from a certain IP (e.g. known spammers) you would want to
limit the amount of memory and CPU cycles they consume by rejecting before the
before <code class="docutils literal notranslate"><span class="pre">DATA</span></code>.</p>
<div class="section" id="creating-smtp-edge-objects">
<h3>Creating SMTP Edge Objects<a class="headerlink" href="#creating-smtp-edge-objects" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">slimta.edge.smtp</span> <span class="k">import</span> <span class="n">SmtpEdge</span>

<span class="n">smtp</span> <span class="o">=</span> <span class="n">SmtpEdge</span><span class="p">((</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span> <span class="n">queue</span><span class="p">)</span>
<span class="n">smtp</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="authentication-with-smtp-edge">
<h3>Authentication with SMTP Edge<a class="headerlink" href="#authentication-with-smtp-edge" title="Permalink to this headline">¶</a></h3>
<p>There are a few steps involved with adding authentication to the edge. The first
is exposing the <code class="docutils literal notranslate"><span class="pre">AUTH</span></code> SMTP extensions to clients by passing <code class="docutils literal notranslate"><span class="pre">auth=True</span></code> to
the <a class="reference internal" href="../api/slimta.edge.smtp.html#slimta.edge.smtp.SmtpEdge" title="slimta.edge.smtp.SmtpEdge"><code class="xref py py-class docutils literal notranslate"><span class="pre">SmtpEdge</span></code></a> constructor.</p>
<p>By default, any credentials will successfully authenticate, so the next step is
adding a <a class="reference internal" href="../api/slimta.edge.smtp.html#slimta.edge.smtp.SmtpValidators" title="slimta.edge.smtp.SmtpValidators"><code class="xref py py-class docutils literal notranslate"><span class="pre">SmtpValidators</span></code></a> class that implements the
<code class="docutils literal notranslate"><span class="pre">handle_auth</span></code> method:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">slimta.edge.smtp</span> <span class="k">import</span> <span class="n">SmtpValidators</span>
<span class="kn">from</span> <span class="nn">slimta.smtp.reply</span> <span class="k">import</span> <span class="n">invalid_credentials</span>

<span class="k">class</span> <span class="nc">MyValidators</span><span class="p">(</span><span class="n">SmtpValidators</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">handle_auth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reply</span><span class="p">,</span> <span class="n">creds</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">secret</span> <span class="o">=</span> <span class="n">valid_creds</span><span class="p">[</span><span class="n">creds</span><span class="o">.</span><span class="n">authcid</span><span class="p">]</span>
            <span class="k">assert</span> <span class="n">creds</span><span class="o">.</span><span class="n">check_secret</span><span class="p">(</span><span class="n">secret</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">AssertionError</span><span class="p">):</span>
            <span class="n">reply</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">invalid_credentials</span><span class="p">)</span>
</pre></div>
</div>
<p>Finally, we’ll want to disallow <code class="docutils literal notranslate"><span class="pre">MAIL</span> <span class="pre">FROM</span></code> commands until there has been a
successful authentication:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">handle_mail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reply</span><span class="p">,</span> <span class="n">sender</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">auth</span><span class="p">:</span>
        <span class="n">reply</span><span class="o">.</span><span class="n">code</span> <span class="o">=</span> <span class="s1">&#39;550&#39;</span>
        <span class="n">reply</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;5.7.1 Sender not allowed&#39;</span>
</pre></div>
</div>
<p>If you have not already, you’ll need to attach your validators to your
<a class="reference internal" href="../api/slimta.edge.smtp.html#slimta.edge.smtp.SmtpEdge" title="slimta.edge.smtp.SmtpEdge"><code class="xref py py-class docutils literal notranslate"><span class="pre">SmtpEdge</span></code></a> by passing in
<code class="docutils literal notranslate"><span class="pre">validator_class=MyValidators</span></code> to its constructor.</p>
</div>
<div class="section" id="proxy-protocol-with-smtp-edge">
<h3>Proxy Protocol with SMTP Edge<a class="headerlink" href="#proxy-protocol-with-smtp-edge" title="Permalink to this headline">¶</a></h3>
<div class="versionadded">
<p><span class="versionmodified">New in version 3.0.0.</span></p>
</div>
<p>When using a TCP proxy in front of <a class="reference external" href="https://slimta.org/">slimta</a>, it is common to lose information
about the original source address of the connection. The <a class="reference external" href="http://www.haproxy.org/download/1.5/doc/proxy-protocol.txt">PROXY protocol</a>
adds a header to each connection where the client posts information about the
request’s original connection information. To use the proxy protocol:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">slimta.edge.smtp</span> <span class="k">import</span> <span class="n">SmtpEdge</span>
<span class="kn">from</span> <span class="nn">slimta.util.proxyproto</span> <span class="k">import</span> <span class="n">ProxyProtocolV1</span>

<span class="k">class</span> <span class="nc">MyEdge</span><span class="p">(</span><span class="n">ProxyProtocolV1</span><span class="p">,</span> <span class="n">SmtpEdge</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="n">smtp</span> <span class="o">=</span> <span class="n">MyEdge</span><span class="p">((</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span> <span class="n">queue</span><span class="p">)</span>
<span class="n">smtp</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</pre></div>
</div>
<p>Please note, this will cause strange behavior if you are not running <a class="reference external" href="https://slimta.org/">slimta</a>
behind a proxy that is configured to use <a class="reference external" href="http://www.haproxy.org/download/1.5/doc/proxy-protocol.txt">PROXY protocol</a> version 1.</p>
</div>
</div>
<div class="section" id="http-edge-services">
<span id="edge-http"></span><h2>HTTP Edge Services<a class="headerlink" href="#http-edge-services" title="Permalink to this headline">¶</a></h2>
<p>A very common desire these days is to be able to submit emails to an MTA using
HTTP or HTTPS protocols, due to the simplicity and ubiquity of these protocols.
Unfortunately, no standards have been settled on, so HTTP mail reception and
delivery can only really be used within controlled environments.</p>
<p>An HTTP session delivering a message from a client to a server might look like
this, with server (edge) replies back to the client bolded:</p>
<pre class="literal-block">
POST / HTTP/1.1
User-Agent: curl/7.29.0
Host: localhost:8080
Accept: */*
Content-Type: message/rfc822
X-Envelope-Sender: c2VuZGVyQGV4YW1wbGUuY29t
X-Envelope-Recipient: cmVjaXBpZW50QGV4YW1wbGUuY29t
Content-Length: 101

From: sender&#64;example.com
To: recipient&#64;example.com
Subject: HTTP mail delivery

Test message!

<strong>HTTP/1.1 200 OK
X-Smtp-Reply: 250; message=&quot;2.6.0 Message accepted for delivery&quot;
Date: Mon, 29 Jul 2013 20:11:55 GMT
Content-Length: 0</strong>
</pre>
<div class="section" id="creating-http-edge-objects">
<h3>Creating HTTP Edge Objects<a class="headerlink" href="#creating-http-edge-objects" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">slimta.edge.wsgi</span> <span class="k">import</span> <span class="n">WsgiEdge</span>

<span class="n">wsgi</span> <span class="o">=</span> <span class="n">WsgiEdge</span><span class="p">(</span><span class="n">queue</span><span class="p">)</span>
<span class="n">http</span> <span class="o">=</span> <span class="n">wsgi</span><span class="o">.</span><span class="n">build_server</span><span class="p">((</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">8025</span><span class="p">))</span>
<span class="n">http</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
        <p class="logo"><a href="../index.html" title="index">
          <img class="logo" src="../_static/slimta.svg" alt="Logo"/>
        </a></p><div class="sphinx-toc sphinxlocaltoc">
    <h3><a href="../index.html">Page contents</a></h3>
    <ul>
<li><a class="reference internal" href="#">Edge Services</a><ul>
<li><a class="reference internal" href="#smtp-edge-services">SMTP Edge Services</a><ul>
<li><a class="reference internal" href="#creating-smtp-edge-objects">Creating SMTP Edge Objects</a></li>
<li><a class="reference internal" href="#authentication-with-smtp-edge">Authentication with SMTP Edge</a></li>
<li><a class="reference internal" href="#proxy-protocol-with-smtp-edge">Proxy Protocol with SMTP Edge</a></li>
</ul>
</li>
<li><a class="reference internal" href="#http-edge-services">HTTP Edge Services</a><ul>
<li><a class="reference internal" href="#creating-http-edge-objects">Creating HTTP Edge Objects</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  </div>
  <div class="sphinxprev">
    <h4>Previous page</h4>
    <p class="topless"><a href="envelopes.html"
                          title="Previous page">&larr; Envelope Objects</a></p>
  </div>
  <div class="sphinxnext">
    <h4>Next page</h4>
    <p class="topless"><a href="queue.html"
                          title="Next page">&rarr; Queue Services</a></p>
  </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
    
    
        <div class="sidebar-toggle-group no-js">
            
            <button class="sidebar-toggle" id="sidebar-hide" title="Hide the sidebar menu">
                 «
                <span class="show-for-small">hide menu</span>
                
            </button>
            <button class="sidebar-toggle" id="sidebar-show" title="Show the sidebar menu">
                
                <span class="show-for-small">menu</span>
                <span class="hide-for-small">sidebar</span>
                 »
            </button>
        </div>
    
      <div class="clearer"></div>
    </div>
    <div class="relbar-bottom">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="queue.html" title="Queue Services"
             >next</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="envelopes.html" title="Envelope Objects"
             >previous</a> &nbsp; &nbsp;</li>
    <li><a href="../index.html">slimta 4.0.8 documentation</a> &#187;</li>

          <li class="nav-item nav-item-1"><a href="index.html" >Usage Manual</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="python-slimta.html" >Python Library Usage</a> &#187;</li> 
      </ul>
    </div>
    </div>


    <div class="footer" role="contentinfo">
        &#169; Copyright 2019, Ian Good.
    </div>
    <!-- cloud_sptheme 1.4 -->
<script type="text/javascript">
  document._EUGO = 'ff80897801813c8394e7';
  document.head.appendChild(function() {
    var s = document.createElement('script');
    s.src = 'https://eugo.io/eugo.js';
    s.async = 1;
    return s;
  }());
</script>

  </body>
</html>